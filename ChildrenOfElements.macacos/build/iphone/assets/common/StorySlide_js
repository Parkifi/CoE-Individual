function StorySlide(e,t,i,o,n,r){this.touchSound=r,this.animatedItems=[],this.storyID=t,this.mediaManager=i,this.speechManager=o,this.fxManager=n,this.mainView=Ti.UI.createView({opacity:0}),this.slideData=e,this.buildElements(),this.mainView.anima=this.animatedItems,this.mainView.remover=this.clean,this.mainView.imageCount=0,this._hasAudioFX=!1}var Transition=require("/common/ItemTransition");StorySlide.prototype.storyID,StorySlide.prototype.mainView,StorySlide.prototype.animatedItems,StorySlide.prototype.mediaManager,StorySlide.prototype.speechManager,StorySlide.prototype.fxManager,StorySlide.prototype._hasAudio,StorySlide.prototype._hasSpeech,StorySlide.prototype._hasAudioFX,StorySlide.prototype._hintScreen,StorySlide.prototype.transition,StorySlide.prototype.getSlide=function(){return this.mainView},StorySlide.prototype.buildElements=function(){this.slideData.stageElements||this.errorDetect("stage elements not found"),_itemsLength=this.slideData.stageElements.length;for(var e=0;_itemsLength>e;e++){var t=this.createSingleElement(this.slideData.stageElements[e],_itemsLength);t.zIndex=e,this.mainView.add(t)}this._hasAudioFX&&this.fxManager.setFX(this.storyID)},StorySlide.prototype.createSingleElement=function(e,t){e.type||this.errorDetect("target type not found");var i;if(e.animation&&e.animation.rotateAxis){var o=this.setAxis(e.animation.rotateAxis);e.properties.anchorPoint=o,e.animation.anchorPoint=o}switch(e.type){case"image":i=this.createSlideImage(e),e.properties.soundFx&&(i.audioFx=e.properties.soundFx,i.fxManager=this.fxManager,this._hasAudioFX=!0);break;case"transition":i=this.createTransition(e),e.properties.soundFx&&(i.audioFx=e.properties.soundFx,i.fxManager=this.fxManager,this._hasAudioFX=!0);break;case"text":i=this.createTextField(e),e.properties.soundFx&&(i.audioFx=e.properties.soundFx,i.fxManager=this.fxManager,this._hasAudioFX=!0);break;case"audio":this._hasAudio="yes",i=this.createSlideAudio(e);break;case"speech":this._hasSpeech="yes",i=this.createSlideSpeech(e);break;case"hint":this._hasHints="yes",i=this.createSlideHint(e),i.visible=!1;break;default:Ti.API.info("create single element, type not found")}if(i.itemCount=t,e.animation){var n=this.animations(e.animation);i._innerAnimation=n,this.animatedItems.push(i)}switch(e.interaction){case"drag":break;case"click":i.clickableItem="enable",i.activeFlag=!0,i.touchEnabled=!0,i.addEventListener("click",function(e){function t(){e.source.activeFlag=!0,clearTimeout(r)}function t(){e.source.activeFlag=!0,clearTimeout(r)}if(e.source.activeFlag){if(e.source._innerAnimation&&!e.source.transitionPlayer){e.source.activeFlag=!1;var i=Titanium.UI.createAnimation(e.source._innerAnimation);i._parent=e.source,e.source.animate(i),i.addEventListener("complete",function(e){e.source._parent.activeFlag=!0})}else if(e.source.transitionPlayer){if(e.source._innerAnimation){var i=Titanium.UI.createAnimation(e.source._innerAnimation);e.source.animate(i)}var o=e.source.transitionPlayer.getClickDelayTime();if(e.source._innerAnimation){var n;e.source._innerAnimation.repeat&&(n=e.source._innerAnimation.duration*e.source._innerAnimation.repeat,e.source._innerAnimation.autoreverse&&(n=2.1*n)),Ti.API.info(n+"<inter === delay> "+o),n>o&&(o=n)}var r=setTimeout(t,o)}else var r=setTimeout(t,1500);e.source.transitionPlayer&&e.source.transitionPlayer.start(),e.source.soundFx&&e.source.fxManager.playFX(e.source.soundFx),e.source.activeFlag=!1}})}return i},StorySlide.prototype.createTransition=function(e){this.transition=new Transition(e,this.storyID);var t=this.transition.getContainer();return t.transitionPlayer=this.transition,t},StorySlide.prototype.createTextField=function(e){slideText="es"==Alloy.Globals.userLanguage?e.properties.text_es:e.properties.text_en,e.properties.text=slideText;var t=this.fontTranslator(e.properties.fontFamily),i={fontSize:e.properties.fontSize+"sp",fontFamily:t};e.properties.font=i;var o=Ti.UI.createLabel(e.properties);return o.touchEnabled=!1,o},StorySlide.prototype.createSlideAudio=function(e){this.mediaManager.setAudio(e,this.storyID),this.mainView.slideAudio=this.mediaManager;var t=Ti.UI.createView({width:1,height:1,top:-10,left:0,visible:0,touchEnabled:!1});return t},StorySlide.prototype.createSlideSpeech=function(e){this.speechManager.setAudio(e,this.storyID),this.mainView.slideSpeech=this.speechManager;var t=Ti.UI.createView({width:1,height:1,top:-10,left:0,visible:0,touchEnabled:!1});return t},StorySlide.prototype.createSlideImage=function(e){var t=Ti.UI.createImageView(e.properties);return t.image=Titanium.Filesystem.applicationCacheDirectory+this.storyID+"/"+e.properties.image,t.touchEnabled=!1,t},StorySlide.prototype.createSlideHint=function(e){var t=Ti.UI.createImageView({width:"100%",height:"100%",top:0});return t.image=Titanium.Filesystem.applicationCacheDirectory+this.storyID+"/"+e.properties.image,t.touchEnabled=!1,this._hintScreen=t,t},StorySlide.prototype.animations=function(e){var t=Ti.UI.create2DMatrix();return e.rotateAxis&&(e.anchorPoint=this.setAxis(e.rotateAxis)),e.rotate&&(t=t.rotate(e.rotate)),e.scale&&(t=t.scale(e.scale.x,e.scale.y)),e.transform=t,e.rotateAxis,Ti.UI.createAnimation(e),e},StorySlide.prototype.animateSlide=function(){if(this.mainView.anima)for(var e=0;this.mainView.anima.length>e;e++){var t=this.mainView.anima[e];if(!t.clickableItem){var i=Ti.UI.createAnimation(t._innerAnimation);t.animate(i),i=null}}},StorySlide.prototype.slideLoaded=function(){function e(t){if(t.source.parentView.children.length>1){var i=t.source.parentView.children[0];i.speech&&i.speech.stopSpeech(),i.slideAudio&&(i.slideAudio.stopAudio(),i.slideAudio=null),i.slideSpeech&&(i.slideSpeech.stopAudio(),i.slideSpeech=null),i.remover(),t.source.parentView.remove(t.source.parentView.children[0])}t.source.parentView.children[0].slideSpeech&&"enabled"==Ti.App.Properties.getString("speechAudioStatus")&&t.source.parentView.children[0].slideSpeech.playAudio(),t.source.parentView.children[0].slideAudio&&"enabled"==Ti.App.Properties.getString("storyAudioStatus")&&t.source.parentView.children[0].slideAudio.playAudio(),t.source.removeEventListener("complete",e),t.source.parentView=null}function t(){o.animateSlide()}var i=Titanium.UI.createAnimation({opacity:1,duration:600});this.mainView.animate(i),i.parentView=this.mainView.parentView,i.addEventListener("complete",e),setTimeout(t,800);var o=this},StorySlide.prototype.setAxis=function(e){var t;switch(e){case"topCenter":t={x:.5,y:0};break;case"topLeft":t={x:0,y:0};break;case"topRight":t={x:1,y:0};break;case"center":t={x:.5,y:.5};break;case"bottomLeft":t={x:0,y:1};break;case"bottomRight":t={x:1,y:1};break;case"bottomCenter":t={x:.5,y:1};break;default:this.errorDetect("no valid axis value")}return t},StorySlide.prototype.errorDetect=function(){},StorySlide.prototype.stopSpeech=function(){this.mainView.speech&&this.mainView.speech.pauseSpeech()},StorySlide.prototype.pauseSpeech=function(){this.mainView.speech&&this.mainView.speech.pauseSpeech()},StorySlide.prototype.hasAudio=function(){return"yes"==this._hasAudio?!0:!1},StorySlide.prototype.hasSpeech=function(){return"yes"==this._hasSpeech?!0:!1},StorySlide.prototype.hasHints=function(){return"yes"==this._hasHints?!0:!1},StorySlide.prototype.showHint=function(){this._hintScreen.visible=!0,this._hintScreen.zIndex=100},StorySlide.prototype.hideHint=function(){this._hintScreen.visible=!1},StorySlide.prototype.clean=function(){this.mainView&&(this.mainView.removeAllChildren(),this.mainView.slideAudio&&this.mainView.slideAudio.stopAudio(),this.mainView.slideSpeech&&this.mainView.slideSpeech.stopAudio()),this.transition&&this.transition.clean(),this.storyID=null,this.mainView=null,this.animatedItems=null,this.transition=null},StorySlide.prototype.fontTranslator=function(e){var t;switch(e){case"oldenburg":t=Alloy.Globals._font_oldenburg;break;case"snowburst":t=Alloy.Globals._font_snowburst;break;case"serapionpro":t=Alloy.Globals._font_serapionPro;break;case"serapionosf":t=Alloy.Globals._font_serapion_bold;break;case"sacramento":t=Alloy.Globals._font_sacramento;break;case"raleway":t=Alloy.Globals._font_ralewayDots;break;case"quando":t=Alloy.Globals._font_quando;break;case"mclaren":t=Alloy.Globals._font_mclaren;break;case"inika":t=Alloy.Globals._font_inika;break;case"glassantiqua":t=Alloy.Globals._font_glassAntiqua;break;case"exo2":t=Alloy.Globals._font_exo2;break;case"didactgothic":t=Alloy.Globals._font_didactGothic;break;case"alegreyasanssc":t=Alloy.Globals._font_alegreyaSansSC;break;case"alegreyasans":t=Alloy.Globals._font_alegreyaSans;break;default:t=Alloy.Globals._font_oldenburg}return t},module.exports=StorySlide;