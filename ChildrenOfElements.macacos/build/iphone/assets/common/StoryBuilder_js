function StoryBuilder(e,t){this.touchSound=t,this.storyID=e,this.createLoadingScreen(),this.audioManager=new AudioSlide("audio",e),this.speechManager=new AudioSlide("speech",e),this.fxManager=new AudioSlide("fx",e)}var Slide=require("/common/StorySlide"),FileDownloader=require("/common/FileDownloader"),AudioSlide=require("/common/AudioSlide"),LoaderScreen=require("/common/LoaderScreen");StoryBuilder.prototype._slides,StoryBuilder.prototype.slide,StoryBuilder.prototype._slideData,StoryBuilder.prototype.loadingScreen,StoryBuilder.prototype.audioMenuButton,StoryBuilder.prototype.speechMenuButton,StoryBuilder.prototype.hintMenuButton,StoryBuilder.prototype.loadContent=function(e){function t(t){function n(e){var t=e.split(/[- :T]/),i=new Date(t[0],t[1]-1,t[2],t[3],t[4],0);return i}function r(){var t=new FileDownloader;t.setLoaderScreen(o);var n=t.makeQueue(a,i);t.downloadMultiFile(n,function(){},function(){f&&Ti.App.Properties.setString("bookID_"+i,f),e()}),t=null,a=null,n=null,lang_sufix=null,builder=null}this._slideData=t;for(var a=[],s=0;this._slideData.length>s;s++)for(var l=0;this._slideData[s].stageElements.length>l;l++)switch(this._slideData[s].stageElements[l].type){case"image":a.push(i+"/"+this._slideData[s].stageElements[l].properties.image),this._slideData[s].stageElements[l].properties.soundFx&&a.push(i+"/"+this._slideData[s].stageElements[l].properties.soundFx);break;case"transition":if(this._slideData[s].stageElements[l].images){for(var u=this._slideData[s].stageElements[l].images,c=0;u.length>c;c++)a.push(i+"/"+u[c]);this._slideData[s].stageElements[l].properties.soundFx&&a.push(i+"/"+this._slideData[s].stageElements[l].properties.soundFx)}break;case"hint":a.push(i+"/"+this._slideData[s].stageElements[l].properties.image);break;case"audio":var d;d="es"==Alloy.Globals.userLanguage?this._slideData[s].stageElements[l].properties.audio_es:this._slideData[s].stageElements[l].properties.audio_en,a.push(i+"/"+d);break;case"speech":var d;d="es"==Alloy.Globals.userLanguage?this._slideData[s].stageElements[l].properties.audio_es:this._slideData[s].stageElements[l].properties.audio_en,a.push(i+"/"+d)}if(this._slideData[0].lastUpdate)if(Ti.App.Properties.getString("bookID_"+i)){var p=n(this._slideData[0].lastUpdate),h=n(Ti.App.Properties.getString("bookID_"+i));if(!(p.getTime()>h.getTime()))return void e();r()}else r();else r();var f=this._slideData[0].lastUpdate}this.parseJSON(this.storyID,t);var i=this.storyID,o=this.loadingScreen},StoryBuilder.prototype.buildSlideJIT=function(e){return this.slide=new Slide(StoryBuilder.prototype._slideData[e],this.storyID,this.audioManager,this.speechManager,this.fxManager,this.touchSound),1==this.slide.hasAudio()?this.hideMenuElement(this.audioMenuButton,!0,1200):this.hideMenuElement(this.audioMenuButton,!1,1200),1==this.slide.hasSpeech()?this.hideMenuElement(this.speechMenuButton,!0,1200):this.hideMenuElement(this.speechMenuButton,!1,1200),1==this.slide.hasHints()?this.hideMenuElement(this.hintMenuButton,!0,1200):this.hideMenuElement(this.hintMenuButton,!1,1200),this.slide},StoryBuilder.prototype.hideMenuElement=function(e,t,i){function o(){e.visible=t}setTimeout(o,i)},StoryBuilder.prototype.createLoadingScreen=function(){var e=new LoaderScreen;this.loadingScreen=e.getLoader()},StoryBuilder.prototype.parseJSON=function(e,t){function i(){var e=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationCacheDirectory,r+"/"+r+".json"),i=e.read().text,o=JSON.parse(i);StoryBuilder.prototype._slideData=o,t(o),e=null,i=null,o=null}var o=Ti.Filesystem.getFile(Titanium.Filesystem.applicationCacheDirectory,this.storyID);o.exists()||o.createDirectory();var n=new FileDownloader;n.downloadOneFile(Alloy.Globals.remoteServerRoot+this.storyID+"/"+this.storyID+".json",Titanium.Filesystem.applicationCacheDirectory+this.storyID+"/"+this.storyID+".json",i);var r=this.storyID;n=null,o=null},StoryBuilder.prototype.clean=function(){this.slide.clean(),this.slide=null,this._slides=null,this._slideData=null,this.audioManager.clean(),this.speechManager.clean(),this.fxManager.clean(),this.audioManager=null,this.speechManager=null,this.fxManager=null,StoryBuilder.prototype._slides=null,StoryBuilder.prototype.slide=null,StoryBuilder.prototype._slideData=null,StoryBuilder.prototype.audioManager=null,StoryBuilder.prototype.speechManager=null,StoryBuilder.prototype.fxManager=null},StoryBuilder.prototype.setButtons=function(e,t,i){this.audioMenuButton=t,this.speechMenuButton=e,this.hintMenuButton=i},StoryBuilder.prototype.stopAudio=function(){this.audioManager&&this.audioManager.stopAudio()},StoryBuilder.prototype.playAudio=function(){this.audioManager&&this.audioManager.playAudio()},StoryBuilder.prototype.stopSpeech=function(){this.speechManager&&this.speechManager.stopAudio()},StoryBuilder.prototype.pauseSpeech=function(){this.speechManager&&this.speechManager.pauseAudio()},StoryBuilder.prototype.playSpeech=function(){this.speechManager&&this.speechManager.playAudio()},StoryBuilder.prototype.cleanAudio=function(){this.audioManager.cleanAudio(),this.speechManager.cleanAudio(),this.fxManager.cleanAudio()},StoryBuilder.prototype.showHint=function(){this.slide.showHint()},StoryBuilder.prototype.hideHint=function(){this.slide.hideHint()},module.exports=StoryBuilder;